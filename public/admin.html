<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸‰å°éš»æ—¥å¸¸ç™¾è²¨ï½œå¾Œå°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Supabase JSï¼ˆå‰ç«¯ä¸Šå‚³åœ–ç‰‡ç”¨ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* =========================================================
     *  ä¸‰å°éš»æ—¥å¸¸ç™¾è²¨ï½œå¾Œå° admin.html
     *  - Reset / Base / Layout / Components / Modules / Responsive
     * ========================================================= */

    /* ============ Reset ============ */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ============ Base ============ */
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
      background: #fff9ec;
      color: #4f3b2a;
      line-height: 1.6;
    }

    a {
      color: inherit;
      text-decoration: none;
    }

    label {
      font-size: 13px;
      color: #6b502c;
    }

    input[type="password"],
    input[type="text"],
    input[type="search"],
    input[type="number"],
    select,
    textarea {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #e0c080;
      font-size: 13px;
      min-width: 200px;
      font-family: inherit;
    }

    textarea {
      min-height: 60px;
      resize: vertical;
    }

    /* ============ Layout ============ */
    header {
      position: sticky;
      top: 0;
      z-index: 10;
      background: rgba(255, 249, 236, 0.95);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid #ffe3aa;
    }

    .nav {
      max-width: 1100px;
      margin: 0 auto;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    main {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    /* ============ Header Branding ============ */
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      font-size: 18px;
      color: #e59b29;
    }

    .logo-badge {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: linear-gradient(135deg, #ffe3a7, #fff4ce);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .nav-right {
      font-size: 13px;
      color: #9a7641;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    /* ============ Common Components ============ */
    .section-title {
      margin: 10px 0 14px;
      font-size: 18px;
      display: flex;
      align-items: baseline;
      gap: 8px;
      color: #e59b29;
    }

    .section-title span {
      font-size: 12px;
      color: #9a7641;
    }

    .card {
      border-radius: 18px;
      background: #fffef8;
      padding: 16px 14px;
      box-shadow: 0 4px 16px rgba(171, 132, 77, 0.25);
      margin-bottom: 18px;
    }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-top: 8px;
    }

    .hint {
      font-size: 12px;
      color: #a17f48;
      margin-top: 6px;
    }

    .msg {
      font-size: 13px;
      margin-top: 6px;
    }

    .msg.error { color: #b5532e; }
    .msg.success { color: #4e7a1a; }

    /* Buttons */
    .btn-primary {
      padding: 6px 14px;
      border-radius: 999px;
      background: linear-gradient(135deg, #f4b73e, #ffd37a);
      border: none;
      color: #3f2b14;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(220, 158, 35, 0.35);
      transition: transform 0.08s, box-shadow 0.08s;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 14px rgba(220, 158, 35, 0.45);
    }
    .btn-primary:active {
      transform: translateY(1px);
      box-shadow: 0 2px 6px rgba(220, 158, 35, 0.3);
    }

    .btn-secondary {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #e0c080;
      background: #fff9ec;
      font-size: 13px;
      cursor: pointer;
    }

    .btn-small {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #e0c080;
      background: #fff9ec;
      font-size: 12px;
      cursor: pointer;
    }

    .btn-small.primary {
      background: #ffe9b8;
      border-color: #f4b73e;
      color: #5a3c11;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #fff7df;
      border: 1px solid #f0d9a4;
      color: #8b6a3b;
    }

    .empty-text {
      font-size: 13px;
      color: #a17f48;
    }

    /* =========================================================
     * Orders Module
     * ========================================================= */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    .badge-status {
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid;
      display: inline-block;
    }

    .status-new {
      border-color: #e5a03d;
      background: #fff7df;
      color: #945716;
    }

    .status-completed {
      border-color: #89b64d;
      background: #f4ffe5;
      color: #486022;
    }

    .status-cancelled {
      border-color: #c66a6a;
      background: #ffecec;
      color: #8a3030;
    }

    .status-shipped {
      border-color: #5aa6c6;
      background: #ecf8ff;
      color: #1f5f77;
    }


    .order-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 580px;
      overflow: auto;
    }

    .order-card {
      border-radius: 14px;
      border: 1px solid #f0d9a4;
      background: #fffdf5;
      padding: 10px 12px;
      font-size: 13px;
    }

    .order-header {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .order-id {
      font-weight: 700;
      color: #4f3b2a;
    }

    .order-meta {
      font-size: 12px;
      color: #9a7641;
    }

    .order-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 4px;
    }

    .order-block {
      min-width: 220px;
    }

    .order-block-title {
      font-size: 12px;
      font-weight: 600;
      color: #7a5c3a;
      margin-bottom: 2px;
    }

    .order-items-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .order-items-table th,
    .order-items-table td {
      padding: 2px 4px;
      border-bottom: 1px dashed #f0d9a4;
    }

    .order-items-table th {
      text-align: left;
      color: #9a7641;
      font-weight: 500;
    }

    .order-actions {
      margin-top: 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      justify-content: flex-end;
    }

    /* =========================================================
     * Products Module
     * ========================================================= */
    .product-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
    }

    .product-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 10px 14px;
      margin-top: 8px;
    }

    .product-form-item label {
      display: block;
      margin-bottom: 2px;
    }

    .product-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 10px;
    }

    .product-table th,
    .product-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #f0d9a4;
      text-align: left;
      vertical-align: top;
    }

    .product-table th {
      background: #fff7df;
      color: #7a5c3a;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    .product-status-on {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #f4ffe5;
      border: 1px solid #89b64d;
      font-size: 11px;
      color: #486022;
    }

    .product-status-off {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      background: #ffecec;
      border: 1px solid #c66a6a;
      font-size: 11px;
      color: #8a3030;
    }

    .product-table-wrapper {
      max-height: 420px;
      overflow: auto;
      border-radius: 12px;
      border: 1px solid #f0d9a4;
      margin-top: 6px;
      background: #fffdf5;
    }

    .product-img-preview {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      border: 1px solid #f0d9a4;
      background: #fff;
    }

    /* ============ Responsive ============ */
    @media (max-width: 768px) {
      .nav {
        flex-wrap: wrap;
        justify-content: center;
      }

      input[type="password"],
      input[type="text"],
      input[type="search"],
      input[type="number"],
      select,
      textarea {
        min-width: 0;
        flex: 1;
      }
    }
  </style>
</head>

<body>
  <!-- =========================================================
   * Header / Navigation
   * ========================================================= -->
  <header>
    <div class="nav">
      <div class="logo">
        <div class="logo-badge">â˜€</div>
        ä¸‰å°éš»æ—¥å¸¸ç™¾è²¨ Â· å¾Œå°
      </div>

      <div class="nav-right">
        <span id="adminStatus">å°šæœªç™»å…¥</span>
        <button class="btn-secondary" id="logoutBtn" style="display:none;">ç™»å‡º</button>
        <a href="/" class="btn-secondary">å›å‰å°</a>
      </div>
    </div>
  </header>

  <main>
    <!-- =========================================================
     * Login Section
     * - å¾Œå°ç™»å…¥ï¼ˆç›®å‰ç°¡æ˜“å¯†ç¢¼ï¼‰
     * ========================================================= -->
    <section class="card" id="loginSection">
      <h2 class="section-title">
        å¾Œå°ç™»å…¥
        <span>ç›®å‰ä½¿ç”¨ç°¡å–®å¯†ç¢¼ç™»å…¥ï¼Œä¹‹å¾Œå¯ä»¥å†é€²åŒ–æˆå¸³è™Ÿç³»çµ±</span>
      </h2>

      <p style="font-size:13px;color:#6b502c;">
        é€™å€‹é é¢æ˜¯çµ¦åº—é•·ç”¨çš„è¨‚å–® / å•†å“ç®¡ç†ç•«é¢ã€‚<br />
        æš«æ™‚ä½¿ç”¨ä¸€çµ„å¾Œå°å¯†ç¢¼ï¼ˆä¾‹ï¼š<code>demo123</code>ï¼‰ï¼Œåªæœ‰çŸ¥é“å¯†ç¢¼çš„äººå¯ä»¥æŸ¥çœ‹ã€‚
      </p>

      <div class="form-row">
        <label for="adminPasswordInput">å¾Œå°å¯†ç¢¼ï¼š</label>
        <input type="password" id="adminPasswordInput" placeholder="è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼" />
        <button class="btn-primary" id="loginBtn">ç™»å…¥</button>
      </div>

      <div class="hint">
        â€» å¯†ç¢¼åªå­˜åœ¨é€™å°è£ç½®çš„è¨˜æ†¶é«”ä¸­ï¼Œä¸æœƒå­˜åˆ° localStorageã€‚<br />
        â€» å¦‚æœç™»å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª server.js è£¡çš„ç®¡ç†å¯†ç¢¼æ˜¯å¦ä¸€è‡´ã€‚
      </div>

      <div id="loginMsg" class="msg"></div>
    </section>

    <!-- =========================================================
     * Orders Section
     * - è¨‚å–®åˆ—è¡¨ / æœå°‹ / ç‹€æ…‹æ›´æ–°
     * ========================================================= -->
    <section class="card" id="ordersSection" style="display:none;">
      <h2 class="section-title">
        è¨‚å–®ç®¡ç†
        <span>æŸ¥çœ‹ä»Šå¤©è¨‚å–®ã€æ¨™è¨˜å·²å®Œæˆã€æŸ¥è©¢æ­·å²è¨‚å–®</span>
      </h2>

      <div class="toolbar">
        <div>
          <span class="badge">ä»Šæ—¥è¨‚å–®ï¼š<span id="todayCount">0</span> ç­†</span>
          <span class="badge">å…¨éƒ¨è¨‚å–®ï¼š<span id="totalCount">0</span> ç­†</span>
        </div>

        <div style="flex:1;"></div>

        <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
          <label style="font-size:12px;">ç‹€æ…‹ç¯©é¸ï¼š</label>
          <select id="statusFilter">
            <option value="all">å…¨éƒ¨</option>
            <option value="new">æœªå®Œæˆ / æ–°è¨‚å–®</option>
            <option value="completed">å·²å®Œæˆ</option>
            <option value="cancelled">å·²å–æ¶ˆ</option>
            <option value="shipped">å·²å‡ºè²¨</option>
          </select>
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
          <label style="font-size:12px;">æœå°‹ï¼š</label>
          <input type="search" id="searchInput" placeholder="æ‰‹æ©Ÿã€è¨‚å–®ç·¨è™Ÿã€å§“åã€Email" />
        </div>

        <button class="btn-secondary" id="refreshBtn">é‡æ–°è¼‰å…¥</button>
      </div>

      <div id="ordersContainer" class="order-list"></div>

      <div id="ordersEmpty" class="empty-text" style="display:none;">
        ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®ã€‚
      </div>
    </section>

    <!-- =========================================================
     * Products Section
     * - æ–°å¢/ç·¨è¼¯å•†å“ã€æ¬¾å¼ã€è©³ç´°åœ–ã€åˆ—è¡¨æ“ä½œ
     * ========================================================= -->
    <section class="card" id="productsSection" style="display:none;">
      <h2 class="section-title">
        å•†å“ç®¡ç†
        <span>æ–°å¢ / ç·¨è¼¯ / ä¸‹æ¶å•†å“ï¼Œå‰å°æœƒåƒé€™è£¡çš„è³‡æ–™</span>
      </h2>

      <!-- å•†å“ç·¨è¼¯è¡¨å–® -->
      <form id="productForm">
        <div class="product-form">
          <div class="product-form-item">
            <label for="productCode">å•†å“ç·¨è™Ÿ</label>
            <input type="text" id="productCode" placeholder="ä¾‹ï¼šBAG-001" />
          </div>

          <div class="product-form-item">
            <label for="productName">å•†å“åç¨±</label>
            <input type="text" id="productName" required placeholder="ä¾‹ï¼šChiikawa å‰ä¼Šå¡å“‡å¸†å¸ƒè¢‹" />
          </div>

          <div class="product-form-item">
            <label for="productPrice">å”®åƒ¹ (NT$)</label>
            <input type="number" id="productPrice" required min="0" step="1" placeholder="ä¾‹ï¼š150" />
          </div>

          <div class="product-form-item">
            <label for="productStock">ç¸½åº«å­˜æ•¸é‡</label>
            <input type="number" id="productStock" required min="0" step="1" placeholder="ä¾‹ï¼š100" />
          </div>

          <div class="product-form-item">
            <label for="productCategory">åˆ†é¡</label>
            <input type="text" id="productCategory" placeholder="ä¾‹ï¼šå¸†å¸ƒè¢‹ / ç”Ÿæ´»å°ç‰©" />
          </div>

          <div class="product-form-item">
            <label for="productStatus">ç‹€æ…‹</label>
            <select id="productStatus">
              <option value="on">ä¸Šæ¶ä¸­</option>
              <option value="off">å·²ä¸‹æ¶</option>
            </select>
          </div>


<div class="product-form-item">
  <label for="productTag">å‡ºè²¨æç¤ºæ¨™ç±¤</label>
  <select id="productTag">
    <option value="">ï¼ˆä¸é¡¯ç¤ºï¼‰</option>
    <option value="leadtime_10_15">è¼ƒé•·å‚™è²¨æ™‚é–“10-15å¤©å‡ºè²¨</option>
  </select>
  <div class="hint">é¸äº†æœƒåœ¨å‰å°å•†å“èˆ‡çµå¸³é¡¯ç¤ºæé†’ã€‚</div>
</div>

          <div class="product-form-item">
            <label for="productImageUrl">ä¸»åœ–åœ–ç‰‡ç¶²å€</label>
            <input type="text" id="productImageUrl" placeholder="è²¼ä¸Š Supabase åœ–ç‰‡ç¶²å€ï¼ˆä¸»åœ–ï¼‰" />
          </div>

          <div class="product-form-item" style="grid-column:1/-1;">
            <label for="productDescription">å•†å“ç°¡ä»‹ / å»£å‘Šè©</label>
            <textarea id="productDescription" placeholder="ä¾‹ï¼šæœ‰ä»»ä½•å•é¡ŒèŠèŠç§è¨Šè©¢å•ğŸ˜† å¯æ‹å¯¦ç‰©åœ–ç¢ºèªå¾Œå†å¯„å‡ºâ˜ºï¸"></textarea>
          </div>

          <!-- æ¬¾å¼èˆ‡åº«å­˜ -->
          <div class="product-form-item" style="grid-column:1/-1;">
            <label>æ¬¾å¼èˆ‡åº«å­˜</label>
            <div class="hint">
              ä¾‹ï¼šæ¬¾å¼ 1 / 10ã€æ¬¾å¼ 2 / 5ã€‚è‹¥ä¸å¡«ï¼Œå‰å°åªçœ‹ã€Œç¸½åº«å­˜æ•¸é‡ã€ã€‚
            </div>

            <div id="variantsContainer"></div>

            <button type="button" class="btn-secondary" id="addVariantBtn" style="margin-top:6px;">
              æ–°å¢æ¬¾å¼
            </button>
          </div>

          <!-- è©³ç´°å°åœ–ä¸Šå‚³ -->
          <div class="product-form-item" style="grid-column:1/-1;">
            <label>å•†å“è©³ç´°å°åœ–</label>
            <div class="hint">
              é¡ä¼¼è¦çš®å•†å“é ä¸‹é¢çš„å°åœ–ï¼Œå¯ä»¥å¤šå¼µã€‚é€™è£¡ä¸Šå‚³åˆ° Supabaseï¼Œä¸¦å­˜æˆåœ–ç‰‡ç¶²å€é™£åˆ—ã€‚
            </div>

            <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-top:4px;">
              <input type="file" id="productDetailImagesInput" accept="image/*" multiple />
              <button type="button" class="btn-secondary" id="productDetailImagesUploadBtn">
                ä¸Šå‚³è©³ç´°åœ–ç‰‡
              </button>
              <span id="productDetailImagesStatus" class="hint">å¯å¤šé¸åœ–ç‰‡ä¸Šå‚³</span>
            </div>

            <div id="productDetailImagesPreview" style="margin-top:8px;display:flex;flex-wrap:wrap;gap:6px;"></div>
          </div>
        </div>

        <!-- ç·¨è™Ÿå¿«é€Ÿè¼‰å…¥ -->
        <div class="form-row" style="margin-top:8px;">
          <label style="font-size:12px;">è¼¸å…¥å•†å“ç·¨è™Ÿè¼‰å…¥ï¼š</label>
          <input type="text" id="productCodeSearchInput" placeholder="è¼¸å…¥ç·¨è™Ÿå¾ŒæŒ‰ã€è¼‰å…¥ã€" />
          <button type="button" class="btn-secondary" id="productCodeSearchBtn">è¼‰å…¥</button>
        </div>

        <!-- è¡¨å–®æ“ä½œåˆ— -->
        <div class="form-row" style="margin-top:10px;justify-content:flex-end;">
          <span id="productFormStatus" class="hint" style="flex:1;">ç›®å‰ç‹€æ…‹ï¼šæ–°å¢æ–°å•†å“</span>
          <button type="button" class="btn-secondary" id="productFormResetBtn">æ¸…ç©º</button>
          <button type="submit" class="btn-primary" id="productFormSubmitBtn">æ–°å¢å•†å“</button>
        </div>
      </form>

      <!-- å•†å“åˆ—è¡¨å·¥å…·åˆ— -->
      <div class="product-toolbar" style="margin-top:14px;">
        <div>
          <span class="badge">å•†å“ç¸½æ•¸ï¼š<span id="productTotalCount">0</span> å€‹</span>
        </div>

        <div style="flex:1;"></div>

        <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
          <label style="font-size:12px;">å¿«é€Ÿé¸æ“‡å•†å“ï¼š</label>
          <select id="productCodeSelect">
            <option value="">é¸æ“‡å•†å“ç·¨è™Ÿâ€¦</option>
          </select>
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
          <label style="font-size:12px;">ç‹€æ…‹ç¯©é¸ï¼š</label>
          <select id="productStatusFilter">
            <option value="all">å…¨éƒ¨</option>
            <option value="on">ä¸Šæ¶ä¸­</option>
            <option value="off">å·²ä¸‹æ¶</option>
          </select>
        </div>

        <div style="display:flex;flex-wrap:wrap;gap:6px;align-items:center;">
          <label style="font-size:12px;">æœå°‹ï¼š</label>
          <input type="search" id="productSearchInput" placeholder="åç¨±ã€åˆ†é¡é—œéµå­—" />
        </div>

        <button type="button" class="btn-secondary" id="productRefreshBtn">é‡æ–°è¼‰å…¥</button>
      </div>

      <!-- å•†å“åˆ—è¡¨ -->
      <div id="productsEmpty" class="empty-text" style="display:none;">
        ç›®å‰æ²’æœ‰å•†å“è³‡æ–™ã€‚
      </div>

      <div class="product-table-wrapper" id="productsTableWrapper" style="display:none;">
        <table class="product-table">
          <thead>
            <tr>
              <th style="width:70px;">ä¸»åœ–</th>
              <th style="width:110px;">å•†å“ç·¨è™Ÿ</th>
              <th>åç¨± / åˆ†é¡</th>
              <th style="width:80px;">å”®åƒ¹</th>
              <th style="width:80px;">ç¸½åº«å­˜</th>
              <th style="width:90px;">ç‹€æ…‹</th>
              <th style="width:110px;">æ¬¾å¼æ•¸</th>
              <th style="width:150px;">æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="productsTableBody"></tbody>
        </table>
      </div>
    </section>

    <!-- =========================================================
     * Supabase Image Upload Test
     * - æ¸¬è©¦ä¸Šå‚³ä¸€å¼µåœ–ç‰‡ä¸¦å–å¾—å…¬é–‹ç¶²å€
     * ========================================================= -->
    <section class="card" id="imageUploadSection" style="display:none;">
      <h2 class="section-title">
        å•†å“åœ–ç‰‡ä¸Šå‚³ï¼ˆSupabase æ¸¬è©¦ï¼‰
        <span>ä¹‹å¾Œæœƒæ•´åˆé€²å•†å“ä¸»åœ– / å°åœ–æ¬„ä½</span>
      </h2>

      <p style="font-size:13px; color:#666;">
        é¸ä¸€å¼µåœ–ç‰‡æŒ‰ã€Œä¸Šå‚³ã€ï¼Œç³»çµ±æœƒä¸Ÿåˆ° Supabase çš„ã€Œç”¢å“åœ–ç‰‡ã€æ¡¶ï¼Œä¸¦å›å‚³å…¬é–‹ç¶²å€ã€‚<br />
        æœªä¾†æœƒæŠŠé€™å€‹ç¶²å€å­˜é€²å•†å“è³‡æ–™è¡¨ï¼Œç”¨ä¾†é¡¯ç¤ºåœ–ç‰‡ã€‚
      </p>

      <div style="margin-top:12px; display:flex; flex-wrap:wrap; gap:8px; align-items:center;">
        <input type="file" id="uploadFileInput" accept="image/*" />
        <button type="button" id="uploadFileBtn" class="btn-primary">ä¸Šå‚³åœ–ç‰‡</button>
        <span id="uploadStatus" style="font-size:12px; color:#a36a1a;"></span>
      </div>

      <div id="uploadResult" style="margin-top:12px; font-size:13px; display:none;">
        åœ–ç‰‡ç¶²å€ï¼š<br />
        <a id="uploadUrl" href="#" target="_blank"></a>
      </div>
    </section>
  </main>

  <script>
    /* =========================================================
     * Config
     * ========================================================= */

    // Supabase è¨­å®šï¼ˆå‰ç«¯ä¸Šå‚³ç”¨ï¼‰
    const SUPABASE_URL = 'https://ckqdimygblkasofycwvr.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_U_ddXefuPHjG2gVvO5p3bQ_OrTAK1hl';
    const IMAGE_BUCKET = 'product-images';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // API Baseï¼ˆéƒ¨ç½²å¾Œè«‹æ”¹æˆ Render ç¶²å€ï¼Œæˆ–ç•™ç©ºç”¨ç›¸å°è·¯å¾‘ï¼‰
    const API_BASE =
  (location.hostname === 'localhost' || location.hostname === '127.0.0.1')
    ? 'http://localhost:3000'
    : location.origin;
    /* =========================================================
     * State
     * ========================================================= */
    let adminPassword = '';
    let adminToken = ''; // (legacy, no longer used)
let allOrders = [];
    let allProducts = [];
    let editingProductId = null;

    // è©³ç´°å°åœ–ï¼ˆSupabase å…¬é–‹ URL é™£åˆ—ï¼‰
    let currentDetailImages = [];

    /* =========================================================
     * DOM Cache
     * ========================================================= */
    const loginSection = document.getElementById('loginSection');
    const ordersSection = document.getElementById('ordersSection');
    const productsSection = document.getElementById('productsSection');
    const imageUploadSection = document.getElementById('imageUploadSection');

    const adminStatus = document.getElementById('adminStatus');
    const loginMsg = document.getElementById('loginMsg');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginBtn = document.getElementById('loginBtn');

    // Orders
    const todayCountEl = document.getElementById('todayCount');
    const totalCountEl = document.getElementById('totalCount');
    const statusFilter = document.getElementById('statusFilter');
    const searchInput = document.getElementById('searchInput');
    const ordersContainer = document.getElementById('ordersContainer');
    const ordersEmpty = document.getElementById('ordersEmpty');

    // Products - Form
    const productForm = document.getElementById('productForm');
    const productNameInput = document.getElementById('productName');
    const productCodeInput = document.getElementById('productCode');
    const productPriceInput = document.getElementById('productPrice');
    const productStockInput = document.getElementById('productStock');
    const productCategoryInput = document.getElementById('productCategory');
    const productStatusInput = document.getElementById('productStatus');
    const productTagInput = document.getElementById('productTag');
    const productImageUrlInput = document.getElementById('productImageUrl');
    const productDescriptionInput = document.getElementById('productDescription');

    const productFormStatus = document.getElementById('productFormStatus');
    const productFormResetBtn = document.getElementById('productFormResetBtn');
    const productFormSubmitBtn = document.getElementById('productFormSubmitBtn');

    // Products - List
    const productTotalCountEl = document.getElementById('productTotalCount');
    const productStatusFilter = document.getElementById('productStatusFilter');
    const productSearchInput = document.getElementById('productSearchInput');
    const productRefreshBtn = document.getElementById('productRefreshBtn');

    const productsEmpty = document.getElementById('productsEmpty');
    const productsTableWrapper = document.getElementById('productsTableWrapper');
    const productsTableBody = document.getElementById('productsTableBody');

    // Products - Quick Load
    const productCodeSelect = document.getElementById('productCodeSelect');
    const productCodeSearchInput = document.getElementById('productCodeSearchInput');
    const productCodeSearchBtn = document.getElementById('productCodeSearchBtn');

    // Variants
    const variantsContainer = document.getElementById('variantsContainer');
    const addVariantBtn = document.getElementById('addVariantBtn');

    // Detail Images
    const productDetailImagesInput = document.getElementById('productDetailImagesInput');
    const productDetailImagesUploadBtn = document.getElementById('productDetailImagesUploadBtn');
    const productDetailImagesStatus = document.getElementById('productDetailImagesStatus');
    const productDetailImagesPreview = document.getElementById('productDetailImagesPreview');

    // Upload Test
    const uploadFileInput = document.getElementById('uploadFileInput');
    const uploadFileBtn = document.getElementById('uploadFileBtn');
    const uploadStatus = document.getElementById('uploadStatus');
    const uploadResult = document.getElementById('uploadResult');
    const uploadUrl = document.getElementById('uploadUrl');

    /* =========================================================
     * API Helpers (auto attach x-admin-token)
     * ========================================================= */
    function buildHeaders(withJson) {
  const headers = {};
  if (withJson) headers['Content-Type'] = 'application/json';
  // âœ… æœ€å®‰å…¨ç‰ˆï¼šå¾Œå°ç™»å…¥æ”¹ HttpOnly Cookieï¼Œæ‰€ä»¥ä¸å†ç”¨ x-admin-token
  headers['x-requested-with'] = 'XMLHttpRequest'; // âœ… é˜² CSRF
  return headers;
}
async function apiGet(path) {
      const res = await fetch(API_BASE + path, { credentials: 'include', headers: buildHeaders(false) });
      const json = await res.json().catch(() => ({}));
      if (!res.ok || json.success === false) {
        throw new Error(json.message || ('HTTP ' + res.status));
      }
      return json;
    }

    async function apiPost(path, data) {
      const res = await fetch(API_BASE + path, {
        method: 'POST',
        credentials: 'include',
        headers: buildHeaders(true),
        body: JSON.stringify(data || {})
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok || json.success === false) {
        throw new Error(json.message || ('HTTP ' + res.status));
      }
      return json;
    }

    async function apiPatch(path, data) {
      const res = await fetch(API_BASE + path, {
        method: 'PATCH',
        credentials: 'include',
        headers: buildHeaders(true),
        body: JSON.stringify(data || {})
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok || json.success === false) {
        throw new Error(json.message || ('HTTP ' + res.status));
      }
      return json;
    }

    async function apiDelete(path) {
      const res = await fetch(API_BASE + path, {
        method: 'DELETE',
        credentials: 'include',
        headers: buildHeaders(true)
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok || json.success === false) {
        throw new Error(json.message || ('HTTP ' + res.status));
      }
      return json;
    }

    /* =========================================================
     * Utils (format / escape / mapping)
     * ========================================================= */
    function showLoginMsg(text, isError) {
      loginMsg.textContent = text;
      loginMsg.className = 'msg ' + (isError ? 'error' : 'success');
    }

    function escapeHtml(str) {
      return String(str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function formatDateTime(v) {
      const d = new Date(v);
      if (isNaN(d.getTime())) return String(v);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const mi = String(d.getMinutes()).padStart(2, '0');
      return `${yyyy}-${mm}-${dd} ${hh}:${mi}`;
    }

    function calcOrderTotal(items) {
      return (items || []).reduce((sum, it) => {
        const price = typeof it.price === 'number' ? it.price : 0;
        const qty = typeof it.qty === 'number' ? it.qty : 0;
        return sum + price * qty;
      }, 0);
    }

    function getShipTypeText(code) {
      switch (code) {
        case '711': return '7-11 è¶…å•†';
        case 'family': return 'å…¨å®¶è¶…å•†';
        case 'hilife': return 'èŠçˆ¾å¯Œ';
        case 'ok': return 'OK è¶…å•†';
        case 'home': return 'å®…é…';
        default: return code || 'â€”';
      }
    }

    function getShipText(code) {
      switch (code) {
        case '711': return 'è¶…å•†å–è²¨ï¼ˆ7-11ï¼‰';
        case 'family': return 'è¶…å•†å–è²¨ï¼ˆå…¨å®¶ï¼‰';
        case 'home': return 'å®…é…åˆ°åºœ';
        default: return code || 'â€”';
      }
    }

    function getPayText(code) {
      switch (code) {
        case 'cod': return 'è²¨åˆ°ä»˜æ¬¾';
        case 'transfer': return 'éŠ€è¡Œè½‰å¸³';
        case 'card': return 'ä¿¡ç”¨å¡';
        default: return code || 'â€”';
      }
    }


function getTagText(tag) {
  switch (tag) {
    case 'leadtime_10_15': return 'è¼ƒé•·å‚™è²¨æ™‚é–“10-15å¤©å‡ºè²¨';
    default: return tag || '';
  }
}

    function getStatusClass(status) {
      switch (status) {
        case 'completed': return 'status-completed';
        case 'cancelled': return 'status-cancelled';
        case 'shipped': return 'status-shipped';
        default: return 'status-new';
      }
    }

    function getStatusText(status) {
      switch (status) {
        case 'shipped': return 'å·²å‡ºè²¨';
        case 'completed': return 'å·²å®Œæˆ';
        case 'cancelled': return 'å·²å–æ¶ˆ';
        default: return 'æœªå®Œæˆ / æ–°è¨‚å–®';
      }
    }

    /* =========================================================
     * Auth (login / logout)
     * ========================================================= */
    loginBtn.addEventListener('click', async () => {
      const pwd = document.getElementById('adminPasswordInput').value.trim();
      if (!pwd) {
        showLoginMsg('è«‹å…ˆè¼¸å…¥å¾Œå°å¯†ç¢¼ã€‚', true);
        return;
      }

      showLoginMsg('ç™»å…¥ä¸­â€¦', false);

      try {
        const result = await apiPost('/api/admin/login', { password: pwd });
        const ok = result.success || result.ok;

        if (!ok) {
          showLoginMsg(result.message || 'ç™»å…¥å¤±æ•—', true);
          return;
        }

        adminPassword = pwd;
        adminToken = ''; // âœ… Cookie ç™»å…¥ï¼Œä¸å†ä½¿ç”¨ token
        adminStatus.textContent = 'å·²ç™»å…¥';
        showLoginMsg(result.message || 'ç™»å…¥æˆåŠŸ', false);
        logoutBtn.style.display = 'inline-block';

        // é¡¯ç¤ºå¾Œå°åŠŸèƒ½å€
        loginSection.style.display = 'none';
        ordersSection.style.display = 'block';
        productsSection.style.display = 'block';
        imageUploadSection.style.display = 'block';

        // è¼‰å…¥è³‡æ–™
        await loadOrders();
        await loadProducts();

      } catch (err) {
        console.error(err);
        showLoginMsg('ç™»å…¥å¤±æ•—ï¼š' + err.message, true);
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await apiPost('/api/admin/logout', {});
} catch (e) {
        console.error(e);
      }

      adminPassword = '';
      adminToken = '';
      allOrders = [];
      allProducts = [];

      adminStatus.textContent = 'å°šæœªç™»å…¥';
      logoutBtn.style.display = 'none';

      ordersContainer.innerHTML = '';
      productsTableBody.innerHTML = '';
      productsTableWrapper.style.display = 'none';
      productsEmpty.style.display = 'none';

      loginSection.style.display = 'block';
      ordersSection.style.display = 'none';
      productsSection.style.display = 'none';
      imageUploadSection.style.display = 'none';
    });

    /* =========================================================
     * Orders (load / render / status)
     * ========================================================= */
    async function loadOrders() {
      ordersContainer.innerHTML = '';
      ordersEmpty.style.display = 'none';

      try {
        const data = await apiGet('/api/admin/orders');
        const orders = data.orders || data.data || [];
        allOrders = Array.isArray(orders) ? orders : [];
        renderOrders();
      } catch (err) {
        console.error(err);
        ordersContainer.innerHTML =
          '<div class="empty-text">è¼‰å…¥è¨‚å–®å¤±æ•—ï¼š' +
          escapeHtml(err.message) +
          '<br>è«‹ç¢ºèª /api/admin/orders æ˜¯å¦æœ‰å¯¦ä½œã€‚</div>';
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', loadOrders);
    statusFilter.addEventListener('change', renderOrders);
    searchInput.addEventListener('input', renderOrders);

    function renderOrders() {
      ordersContainer.innerHTML = '';

      let filtered = allOrders.slice();

      // ç‹€æ…‹ç¯©é¸
      const statusVal = statusFilter.value;
      function normalizeStatus(s) {
  if (!s) return 'new';
  if (s === 'pending') return 'new';   // âœ… é‡é»ï¼šæŠŠ pending ç•¶ new
  return s;
}

if (statusVal !== 'all') {
  filtered = filtered.filter(o => normalizeStatus(o.status) === statusVal);
}


      // é—œéµå­—æœå°‹
      const keyword = searchInput.value.trim().toLowerCase();
      if (keyword) {
        filtered = filtered.filter(o => {
          const fields = [
            o.id || '',
            (o.customer && o.customer.name) || '',
            (o.customer && o.customer.phone) || '',
            (o.customer && o.customer.email) || ''
          ].join(' ').toLowerCase();
          return fields.includes(keyword);
        });
      }

      // çµ±è¨ˆï¼šå…¨éƒ¨ã€ä»Šæ—¥
      totalCountEl.textContent = String(allOrders.length);

      const today = new Date();
      const todayStr = today.toISOString().slice(0, 10);
      const todayOrders = allOrders.filter(o => {
        if (!o.createdAt) return false;
        const d = new Date(o.createdAt);
        if (isNaN(d.getTime())) return false;
        return d.toISOString().slice(0, 10) === todayStr;
      });
      todayCountEl.textContent = String(todayOrders.length);

      if (filtered.length === 0) {
        ordersEmpty.style.display = 'block';
        return;
      }
      ordersEmpty.style.display = 'none';

      filtered.forEach(o => {
        const card = document.createElement('div');
        card.className = 'order-card';

        const createdAt = o.createdAt ? formatDateTime(o.createdAt) : 'â€”';
        const statusClass = getStatusClass(o.status);
        const statusText = getStatusText(o.status);

        const customer = o.customer || {};
        const items = Array.isArray(o.items) ? o.items : [];

        // é‡‘é¡è¨ˆç®—ï¼ˆå…¼å®¹ä½ å¾Œç«¯å¯èƒ½å›å‚³ subtotal / shippingFee / totalAmountï¼‰
        const subtotal = typeof o.subtotal === 'number' ? o.subtotal : calcOrderTotal(items);
        const totalAmount = typeof o.totalAmount === 'number' ? o.totalAmount : subtotal;
        const shippingFee = typeof o.shippingFee === 'number'
          ? o.shippingFee
          : Math.max(0, totalAmount - subtotal);

        const freeShip = shippingFee === 0;
        const shipType = o.shipType || (customer && customer.ship) || '';

        card.innerHTML = `
          <div class="order-header">
            <div>
              <div class="order-id">è¨‚å–®ç·¨è™Ÿï¼š${escapeHtml(o.id || '')}</div>
              <div class="order-meta">
                å»ºç«‹æ™‚é–“ï¼š${escapeHtml(createdAt)}
                Â· ç‹€æ…‹ï¼š
                <span class="badge-status ${statusClass}">${statusText}</span>
              </div>
            </div>

            <div class="order-meta">
              <div>å°è¨ˆï¼šNT$ ${subtotal}</div>
              <div>
                é‹è²»ï¼š
                <strong style="color:${freeShip ? '#2e9d44' : '#c0392b'}">
                  ${freeShip ? 'å…é‹' : 'NT$ ' + shippingFee}
                </strong>
              </div>
              <div style="margin-top:4px;font-weight:700;">
                ç¸½è¨ˆï¼šNT$ ${totalAmount}
              </div>
              <div style="margin-top:4px;font-size:12px;color:#9a7641;">
                é…é€ï¼š${escapeHtml(getShipTypeText(shipType))}
                Â· ${freeShip ? 'æ»¿é¡å…é‹' : 'æœªé”å…é‹'}
              </div>
            </div>
          </div>

          <div class="order-row">
            <div class="order-block">
              <div class="order-block-title">æ”¶ä»¶äººè³‡è¨Š</div>
              <div>${escapeHtml(customer.name || 'â€”')}</div>
              <div>æ‰‹æ©Ÿï¼š${escapeHtml(customer.phone || 'â€”')}</div>
              <div>Emailï¼š${escapeHtml(customer.email || 'â€”')}</div>
              <div>Line IDï¼š${escapeHtml(customer.lineId || 'â€”')}</div>
            </div>

            <div class="order-block">
              <div class="order-block-title">é…é€ / ä»˜æ¬¾</div>
              <div>é…é€æ–¹å¼ï¼š${escapeHtml(getShipText(customer.ship))}</div>
              <div>ä»˜æ¬¾æ–¹å¼ï¼š${escapeHtml(getPayText(customer.pay))}</div>
              <div>åœ°å€ / å–è²¨é–€å¸‚ï¼š</div>
              <div>${escapeHtml(customer.address || 'â€”')}</div>
            </div>

            <div class="order-block" style="flex:1;min-width:260px;">
              <div class="order-block-title">å•†å“æ˜ç´°</div>
              <table class="order-items-table">
                <thead>
                  <tr>
                    <th>å•†å“</th>
                    <th>æ¬¾å¼</th>
                    <th>æ•¸é‡</th>
                    <th>å–®åƒ¹</th>
                    <th>å°è¨ˆ</th>
                  </tr>
                </thead>
                <tbody>
                  ${items.map(it => {
                    const lineTotal = (it.price || 0) * (it.qty || 0);
                    return `
                      <tr>
                        <td>${escapeHtml(it.name || '')}</td>
                        <td>${escapeHtml(it.specLabel || '')}</td>
                        <td>${it.qty || 0}</td>
                        <td>${it.price || 0}</td>
                        <td>${lineTotal}</td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>

          <div class="order-row" style="margin-top:8px;">
            <div class="order-block" style="flex:1;">
              <div class="order-block-title">å‚™è¨»</div>
              <div>${escapeHtml(customer.note || 'ï¼ˆç„¡å‚™è¨»ï¼‰')}</div>
            </div>
          </div>

          <div class="order-actions">
            <button class="btn-small" data-action="mark-new">æ¨™è¨˜ç‚ºæœªå®Œæˆ</button>
            <button class="btn-small primary" data-action="mark-done">æ¨™è¨˜ç‚ºå·²å®Œæˆ</button>
            <button class="btn-small" data-action="mark-ship">æ¨™è¨˜ç‚ºå·²å‡ºè²¨</button>
            <button class="btn-small" data-action="mark-cancel">æ¨™è¨˜ç‚ºå·²å–æ¶ˆ</button>
          </div>
        `;

        card.querySelector('[data-action="mark-new"]')
          .addEventListener('click', () => changeOrderStatus(o.id, 'new'));

        card.querySelector('[data-action="mark-done"]')
          .addEventListener('click', () => changeOrderStatus(o.id, 'completed'));


        card.querySelector('[data-action="mark-ship"]')
          .addEventListener('click', () => changeOrderStatus(o.id, 'shipped'));

        card.querySelector('[data-action="mark-cancel"]')
          .addEventListener('click', () => changeOrderStatus(o.id, 'cancelled'));

        ordersContainer.appendChild(card);
      });
    }

    async function changeOrderStatus(orderId, status) {
      if (!orderId) return;

      const label = getStatusText(status);
      const ok = confirm(`ç¢ºå®šè¦å°‡è¨‚å–®ã€Œ${orderId}ã€æ¨™è¨˜ç‚ºã€Œ${label}ã€å—ï¼Ÿ`);
      if (!ok) return;

      try {
        await apiPatch('/api/admin/orders/' + encodeURIComponent(orderId), { status });
        const target = allOrders.find(o => o.id === orderId);
        if (target) target.status = status;
        renderOrders();
        alert('è¨‚å–®ç‹€æ…‹å·²æ›´æ–°ç‚ºï¼š' + label);
      } catch (err) {
        console.error(err);
        alert('æ›´æ–°å¤±æ•—ï¼š' + err.message);
      }
    }

    /* =========================================================
     * Products (load / render / edit / create / delete)
     * ========================================================= */
    async function loadProducts() {
      productsTableBody.innerHTML = '';
      productsEmpty.style.display = 'none';
      productsTableWrapper.style.display = 'none';
      productTotalCountEl.textContent = '0';

      try {
        const data = await apiGet('/api/admin/products');
        const products = data.products || data.data || [];
        allProducts = Array.isArray(products) ? products : [];
        updateProductCodeSelect();
        renderProducts();
      } catch (err) {
        console.error(err);
        productsEmpty.style.display = 'block';
        productsEmpty.textContent =
          'è¼‰å…¥å•†å“å¤±æ•—ï¼š' + err.message +
          'ï¼Œè«‹ç¢ºèª /api/admin/products æ˜¯å¦æœ‰å¯¦ä½œã€‚';
      }
    }

    productRefreshBtn.addEventListener('click', loadProducts);
    productStatusFilter.addEventListener('change', renderProducts);
    productSearchInput.addEventListener('input', renderProducts);

    productCodeSelect.addEventListener('change', () => {
      const id = productCodeSelect.value;
      if (!id) return;
      const p = allProducts.find(x => String(x.id) === String(id));
      if (p) fillProductForm(p);
    });

    productCodeSearchBtn.addEventListener('click', () => {
      const code = productCodeSearchInput.value.trim();
      if (!code) {
        productFormStatus.textContent = 'è«‹å…ˆè¼¸å…¥å•†å“ç·¨è™Ÿ';
        return;
      }
      const p = allProducts.find(x => (x.code || '') === code);
      if (!p) {
        productFormStatus.textContent = 'æ‰¾ä¸åˆ°è©²å•†å“ç·¨è™Ÿ';
        return;
      }
      fillProductForm(p);
    });

    function updateProductCodeSelect() {
      productCodeSelect.innerHTML = '<option value="">é¸æ“‡å•†å“ç·¨è™Ÿâ€¦</option>';

      const list = allProducts
        .slice()
        .sort((a, b) => (a.code || '').localeCompare(b.code || ''));

      list.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        const code = p.code || '(ç„¡ç·¨è™Ÿ)';
        opt.textContent = code + ' - ' + (p.name || '');
        productCodeSelect.appendChild(opt);
      });
    }

    function renderProducts() {
      productsTableBody.innerHTML = '';

      if (!Array.isArray(allProducts) || allProducts.length === 0) {
        productsEmpty.style.display = 'block';
        productsTableWrapper.style.display = 'none';
        productTotalCountEl.textContent = '0';
        return;
      }

      let filtered = allProducts.slice();

      const statusVal = productStatusFilter.value;
      if (statusVal !== 'all') {
        filtered = filtered.filter(p => (p.status || 'on') === statusVal);
      }

      const keyword = productSearchInput.value.trim().toLowerCase();
      if (keyword) {
        filtered = filtered.filter(p => {
          const fields = [p.name || '', p.category || '', p.code || '']
            .join(' ')
            .toLowerCase();
          return fields.includes(keyword);
        });
      }

      productTotalCountEl.textContent = String(allProducts.length);

      if (filtered.length === 0) {
        productsEmpty.style.display = 'block';
        productsTableWrapper.style.display = 'none';
        return;
      }

      productsEmpty.style.display = 'none';
      productsTableWrapper.style.display = 'block';

      filtered.forEach(p => {
        const tr = document.createElement('tr');

        const price = typeof p.price === 'number' ? p.price : Number(p.price || 0);
        const stock = typeof p.stock === 'number' ? p.stock : Number(p.stock || 0);
        const imgUrl = p.imageUrl || '';
        const variants = Array.isArray(p.variants) ? p.variants : [];
        const statusVal2 = p.status || 'on';

        const statusClass = statusVal2 === 'on' ? 'product-status-on' : 'product-status-off';
        const statusText = statusVal2 === 'on' ? 'ä¸Šæ¶ä¸­' : 'å·²ä¸‹æ¶';

        tr.innerHTML = `
          <td>
            ${
              imgUrl
                ? `<img src="${escapeHtml(imgUrl)}" class="product-img-preview" referrerpolicy="no-referrer" />`
                : '<span style="font-size:11px;color:#b8a27f;">(ç„¡åœ–ç‰‡)</span>'
            }
          </td>
          <td>${escapeHtml(p.code || '')}</td>
          <td>
            <div style="font-weight:600;color:#4f3b2a;">${escapeHtml(p.name || '')}</div>
            <div style="font-size:12px;color:#9a7641;margin-top:2px;">
              åˆ†é¡ï¼š${escapeHtml(p.category || 'æœªåˆ†é¡')}
            </div>
            ${p.tag ? `<div style=\"margin-top:4px;\"><span class=\"badge\">${escapeHtml(getTagText(p.tag))}</span></div>` : ''}
          </td>
          <td>NT$ ${price}</td>
          <td>${stock}</td>
          <td><span class="${statusClass}">${statusText}</span></td>
          <td>${variants.length} æ¬¾</td>
          <td>
            <button class="btn-small" data-action="edit">ç·¨è¼¯</button>
            <button class="btn-small" data-action="toggle-status">
              ${statusVal2 === 'on' ? 'ä¸‹æ¶' : 'ä¸Šæ¶'}
            </button>
            <button class="btn-small" data-action="delete">åˆªé™¤</button>
          </td>
        `;

        tr.querySelector('[data-action="edit"]').addEventListener('click', () => fillProductForm(p));
        tr.querySelector('[data-action="toggle-status"]').addEventListener('click', () => toggleProductStatus(p));
        tr.querySelector('[data-action="delete"]').addEventListener('click', () => deleteProduct(p));

        productsTableBody.appendChild(tr);
      });
    }

    function fillProductForm(p) {
      editingProductId = p.id;

      productCodeInput.value = p.code || '';
      productNameInput.value = p.name || '';
      productPriceInput.value = p.price != null ? p.price : '';
      productStockInput.value = p.stock != null ? p.stock : '';
      productCategoryInput.value = p.category || '';
      productStatusInput.value = p.status || 'on';
      productTagInput.value = p.tag || '';
      productImageUrlInput.value = p.imageUrl || '';
      productDescriptionInput.value = p.description || '';

      setVariantsInForm(p.variants || []);

      currentDetailImages = Array.isArray(p.detailImages) ? p.detailImages.slice() : [];
      renderDetailImages();

      productFormStatus.textContent = 'ç›®å‰æ­£åœ¨ç·¨è¼¯å•†å“ï¼š' + (p.name || '');
      productFormSubmitBtn.textContent = 'å„²å­˜ä¿®æ”¹';
    }

    function resetProductForm() {
      editingProductId = null;
      productForm.reset();

      productStatusInput.value = 'on';
      productTagInput.value = '';
      variantsContainer.innerHTML = '';

      currentDetailImages = [];
      renderDetailImages();

      productFormStatus.textContent = 'ç›®å‰ç‹€æ…‹ï¼šæ–°å¢æ–°å•†å“';
      productFormSubmitBtn.textContent = 'æ–°å¢å•†å“';
    }

    productFormResetBtn.addEventListener('click', resetProductForm);

    productForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const payload = {
        code: productCodeInput.value.trim(),
        name: productNameInput.value.trim(),
        price: Number(productPriceInput.value || 0),
        stock: Number(productStockInput.value || 0),
        category: productCategoryInput.value.trim(),
        status: productStatusInput.value,
        tag: productTagInput.value,
        imageUrl: productImageUrlInput.value.trim(),
        description: productDescriptionInput.value.trim(),
        variants: getVariantsFromForm(),
        detailImages: currentDetailImages
      };

      if (!payload.name) {
        productFormStatus.textContent = 'è«‹è¼¸å…¥å•†å“åç¨±ã€‚';
        return;
      }

      if (isNaN(payload.price)) payload.price = 0;
      if (isNaN(payload.stock)) payload.stock = 0;

      try {
        productFormStatus.textContent = 'é€å‡ºä¸­â€¦';

        if (editingProductId) {
          await apiPatch('/api/admin/products/' + encodeURIComponent(editingProductId), payload);
          productFormStatus.textContent = 'å•†å“å·²æ›´æ–°ã€‚';
        } else {
          await apiPost('/api/admin/products', payload);
          productFormStatus.textContent = 'å•†å“å·²æ–°å¢ã€‚';
        }

        await loadProducts();
        resetProductForm();

      } catch (err) {
        console.error(err);
        productFormStatus.textContent = 'é€å‡ºå¤±æ•—ï¼š' + err.message;
      }
    });

    async function toggleProductStatus(p) {
      const newStatus = (p.status || 'on') === 'on' ? 'off' : 'on';
      const label = newStatus === 'on' ? 'ä¸Šæ¶' : 'ä¸‹æ¶';
      const ok = confirm(`ç¢ºå®šè¦å°‡å•†å“ã€Œ${p.name || ''}ã€${label}å—ï¼Ÿ`);
      if (!ok) return;

      try {
        await apiPatch('/api/admin/products/' + encodeURIComponent(p.id), { status: newStatus });
        const target = allProducts.find(x => x.id === p.id);
        if (target) target.status = newStatus;
        renderProducts();
        alert('å•†å“å·²' + label + 'ã€‚');
      } catch (err) {
        console.error(err);
        alert('æ›´æ–°å¤±æ•—ï¼š' + err.message);
      }
    }

    async function deleteProduct(p) {
      const ok = confirm(`ç¢ºå®šè¦åˆªé™¤å•†å“ã€Œ${p.name || ''}ã€å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚`);
      if (!ok) return;

      try {
        await apiDelete('/api/admin/products/' + encodeURIComponent(p.id));
        allProducts = allProducts.filter(x => x.id !== p.id);
        renderProducts();
        alert('å•†å“å·²åˆªé™¤ã€‚');
      } catch (err) {
        console.error(err);
        alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
      }
    }

    /* =========================================================
     * Variants (æ¬¾å¼ï¼šæ–°å¢/è®€å–/å›å¡«)
     * ========================================================= */
    function updateVariantImageOptions() {
      const rows = variantsContainer.querySelectorAll('.variant-row');

      rows.forEach(row => {
        const select = row.querySelector('.variant-image');
        if (!select) return;

        const selectedBefore = select.value || select.dataset.selectedImage || '';
        select.innerHTML = '';

        const optDefault = document.createElement('option');
        optDefault.value = '';
        optDefault.textContent = 'ä½¿ç”¨ä¸»åœ–';
        select.appendChild(optDefault);

currentDetailImages.forEach((url) => {
  const opt = document.createElement('option');
  opt.value = url;

  // å–å‡ºåœ–ç‰‡æª”åï¼ˆå¾ç¶²å€æœ€å¾Œä¸€æ®µï¼‰
  const filename = url.split('/').pop();

  opt.textContent = filename;
  select.appendChild(opt);

        });

        if (selectedBefore) select.value = selectedBefore;
      });
    }

    function addVariantRow(variant) {
      const row = document.createElement('div');
      row.className = 'variant-row';
      row.style.display = 'flex';
      row.style.gap = '6px';
      row.style.marginTop = '4px';
      row.style.alignItems = 'center';

      const nameInput = document.createElement('input');
      nameInput.type = 'text';
      nameInput.className = 'variant-name';
      nameInput.placeholder = 'æ¬¾å¼åç¨±ï¼ˆä¾‹ï¼šç´…ã€è—ã€1ã€2ã€3ï¼‰';
      nameInput.value = (variant && variant.name) ? variant.name : '';

      const stockInput = document.createElement('input');
      stockInput.type = 'number';
      stockInput.className = 'variant-stock';
      stockInput.placeholder = 'åº«å­˜';
      stockInput.min = '0';
      stockInput.step = '1';
      stockInput.style.width = '70px';
      stockInput.value =
        (variant && typeof variant.stock === 'number')
          ? variant.stock
          : (variant && variant.stock) || '';

      const imgSelect = document.createElement('select');
      imgSelect.className = 'variant-image';
      imgSelect.style.minWidth = '120px';
      imgSelect.dataset.selectedImage = (variant && variant.imageUrl) || '';

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn-small';
      removeBtn.textContent = 'åˆªé™¤';
      removeBtn.addEventListener('click', () => row.remove());

      row.appendChild(nameInput);
      row.appendChild(stockInput);
      row.appendChild(imgSelect);
      row.appendChild(removeBtn);
      variantsContainer.appendChild(row);

      updateVariantImageOptions();
    }

    function getVariantsFromForm() {
      const rows = variantsContainer.querySelectorAll('.variant-row');
      const variants = [];

      rows.forEach(row => {
        const name = row.querySelector('.variant-name').value.trim();
        const stockVal = row.querySelector('.variant-stock').value;
        const imgSelect = row.querySelector('.variant-image');

        if (!name) return;

        const stock = Number(stockVal || 0);
        variants.push({
          name,
          stock: isNaN(stock) ? 0 : stock,
          imageUrl: (imgSelect && imgSelect.value) ? imgSelect.value : null
        });
      });

      return variants;
    }

    function setVariantsInForm(variants) {
      variantsContainer.innerHTML = '';
      (variants || []).forEach(v => addVariantRow(v));
      updateVariantImageOptions();
    }

    addVariantBtn.addEventListener('click', () => addVariantRow());

    /* =========================================================
     * Detail Images (è©³ç´°åœ–ï¼šé è¦½/åˆªé™¤/æ›´æ–°ä¸‹æ‹‰é¸å–®)
     * ========================================================= */
    function renderDetailImages() {
      productDetailImagesPreview.innerHTML = '';

      currentDetailImages.forEach((url, index) => {
        const wrap = document.createElement('div');
        wrap.style.position = 'relative';

        const img = document.createElement('img');
        img.src = url;
        img.className = 'product-img-preview';
        img.style.width = '70px';
        img.style.height = '70px';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn-small';
        btn.textContent = 'Ã—';
        btn.style.position = 'absolute';
        btn.style.top = '-6px';
        btn.style.right = '-6px';
        btn.style.fontSize = '10px';
        btn.addEventListener('click', () => {
          currentDetailImages.splice(index, 1);
          renderDetailImages();
        });

        wrap.appendChild(img);
        wrap.appendChild(btn);
        productDetailImagesPreview.appendChild(wrap);
      });

      updateVariantImageOptions();
    }

    // ä¸Šå‚³è©³ç´°åœ–ç‰‡åˆ° Supabaseï¼ˆå¤šå¼µï¼‰
    productDetailImagesUploadBtn.addEventListener('click', async () => {
      const files = productDetailImagesInput.files;

      if (!files || files.length === 0) {
        productDetailImagesStatus.textContent = 'è«‹å…ˆé¸æ“‡è¦ä¸Šå‚³çš„åœ–ç‰‡';
        return;
      }

      productDetailImagesStatus.textContent = 'ä¸Šå‚³ä¸­â€¦';

      try {
        const promises = [];

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          
// å–å‰¯æª”å
const ext = (file.name.split('.').pop() || 'jpg').toLowerCase();

// å–åŸå§‹æª”åï¼ˆä¸å«å‰¯æª”åï¼‰ä¸¦åšå®‰å…¨åŒ–ï¼ˆé¿å…ç©ºç™½/å¥‡æ€ªç¬¦è™Ÿï¼‰
const originalBase = file.name.replace(/\.[^/.]+$/, '');
const safeBase = originalBase
  .trim()
  .replace(/\s+/g, '_')                 // ç©ºç™½è®Šåº•ç·š
  .replace(/[^a-zA-Z0-9\u4e00-\u9fa5_-]/g, '') // åªä¿ç•™è‹±æ•¸/ä¸­æ–‡/_/-
  .slice(0, 40) || 'image';

// æª”åï¼šæ™‚é–“æˆ³ + åŸå§‹å + indexï¼ˆå¯è®€ã€ä¹Ÿä¸å¤ªæœƒæ’åï¼‰
const fileName = `${Date.now()}-${safeBase}-${i}.${ext}`;


          const filePath = 'detail/' + fileName;

          const p = supabase
            .storage
            .from(IMAGE_BUCKET)
            .upload(filePath, file, { cacheControl: '3600', upsert: false })
            .then(({ error }) => {
              if (error) throw error;

              const { data: publicData } = supabase
                .storage
                .from(IMAGE_BUCKET)
                .getPublicUrl(filePath);

              currentDetailImages.push(publicData.publicUrl);
            });

          promises.push(p);
        }

        await Promise.all(promises);

        productDetailImagesStatus.textContent = 'ä¸Šå‚³æˆåŠŸï¼';
        productDetailImagesInput.value = '';
        renderDetailImages();

      } catch (err) {
        console.error(err);
        productDetailImagesStatus.textContent = 'ä¸Šå‚³å¤±æ•—ï¼š' + err.message;
      }
    });

    /* =========================================================
     * Upload Test (å–®å¼µæ¸¬è©¦ä¸Šå‚³)
     * ========================================================= */
    uploadFileBtn.addEventListener('click', async () => {
      console.log('IMAGE_BUCKET =', IMAGE_BUCKET);

      const file = uploadFileInput.files[0];
      if (!file) {
        uploadStatus.textContent = 'è«‹å…ˆé¸ä¸€å¼µåœ–ç‰‡ã€‚';
        return;
      }

      uploadStatus.textContent = 'ä¸Šå‚³ä¸­â€¦';
      uploadResult.style.display = 'none';

      try {
        const ext = file.name.split('.').pop();
        const fileName =
          Date.now().toString() +
          '-' + Math.random().toString(36).slice(2, 8) +
          '.' + ext;

        const filePath = 'test/' + fileName;

        const { error } = await supabase
          .storage
          .from(IMAGE_BUCKET)
          .upload(filePath, file, { cacheControl: '3600', upsert: false });

        if (error) throw error;

        const { data: publicData } = supabase
          .storage
          .from(IMAGE_BUCKET)
          .getPublicUrl(filePath);

        const publicUrl = publicData.publicUrl;

        uploadStatus.textContent = 'ä¸Šå‚³æˆåŠŸï¼';
        uploadResult.style.display = 'block';
        uploadUrl.href = publicUrl;
        uploadUrl.textContent = publicUrl;

        // æ–¹ä¾¿æ“ä½œï¼šè‡ªå‹•æŠŠç¶²å€å¡åˆ°ã€Œä¸»åœ–æ¬„ä½ã€
        productImageUrlInput.value = publicUrl;

      } catch (err) {
        console.error(err);
        uploadStatus.textContent = 'ä¸Šå‚³å¤±æ•—ï¼š' + err.message;
        uploadResult.style.display = 'none';
      }
    });
  </script>
<script>
// ===== Auto total stock (read-only) =====
function calcTotalStockFromVariants(variants) {
  try {
    if (!Array.isArray(variants) || variants.length === 0) return null;
    return variants.reduce((s, v) => s + (Number(v?.stock || 0) || 0), 0);
  } catch { return null; }
}

function refreshTotalStockUI() {
  const stockInput = document.getElementById('pStock') || document.querySelector('input[name="stock"]');
  if (!stockInput) return;

  // å‡è¨­ä½ å¾Œå°ç”¨ currentVariants / variantsArray ä¹‹é¡çš„å…¨åŸŸè®Šæ•¸ï¼ˆæˆ‘å€‘åšå¤šç¨®å…¼å®¹ï¼‰
  const variants =
    window.currentVariants ||
    window.variants ||
    window.variantsArray ||
    (typeof getVariantsFromForm === 'function' ? getVariantsFromForm() : null) ||
    null;

  const total = calcTotalStockFromVariants(variants);
  if (total == null) {
    // æ²’æœ‰æ¬¾å¼ï¼šå°±é¡¯ç¤ºç›®å‰çš„å€¼ï¼Œä½†ä»ç¶­æŒå”¯è®€ï¼ˆé¿å…æ‰‹æ»‘ï¼‰
    stockInput.value = Number(stockInput.value || 0) || 0;
  } else {
    stockInput.value = total;
  }
}

// ç›£è½ï¼šåªè¦ä½ æ”¹æ¬¾å¼åº«å­˜ï¼Œå°±æ›´æ–°ç¸½åº«å­˜
document.addEventListener('input', (e) => {
  const t = e.target;
  if (!t) return;
  // å¸¸è¦‹ï¼šæ¬¾å¼åº«å­˜ input æœƒæœ‰ class / name åŒ…å« stock
  if ((t.name && t.name.toLowerCase().includes('stock')) || (t.className && String(t.className).toLowerCase().includes('stock'))) {
    // è®“æ—¢æœ‰ç¨‹å¼å…ˆæ›´æ–° variantsï¼Œå†ä¾†ç®—ç¸½åº«å­˜
    setTimeout(refreshTotalStockUI, 0);
  }
});

// è¼‰å…¥å¾Œå…ˆç®—ä¸€æ¬¡
window.addEventListener('load', () => setTimeout(refreshTotalStockUI, 0));
</script>

</body>
</html>
