<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>å¾Œå°ç®¡ç†ï½œä¸‰å°éš»æ—¥å¸¸ç™¾è²¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif;
      background: #fff9ec;
      color: #4f3b2a;
      line-height: 1.6;
    }
    header {
      background: #ffe9b8;
      padding: 12px 16px;
      box-shadow: 0 2px 8px rgba(171,132,77,0.35);
    }
    .header-inner {
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: #e59b29;
    }
    .logo-badge {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: linear-gradient(135deg,#ffe3a7,#fff4ce);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    main {
      max-width: 1100px;
      margin: 14px auto;
      padding: 0 16px 24px;
    }
    .tag {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #fffdf5;
      border: 1px solid #ffd98b;
      color: #9a7641;
      display: inline-block;
      margin-left: 8px;
    }
    .card {
      border-radius: 16px;
      background: #fffef8;
      box-shadow: 0 4px 16px rgba(171,132,77,0.25);
      padding: 14px 16px;
      margin-bottom: 18px;
    }
    .card-title {
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
      color: #e59b29;
    }
    .card-sub {
      font-size: 12px;
      color: #9a7641;
      margin-bottom: 8px;
    }
    .btn-primary, .btn-secondary {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      white-space: nowrap;
    }
    .btn-primary {
      background: linear-gradient(135deg,#f4b73e,#ffd37a);
      color: #3f2b14;
      box-shadow: 0 4px 10px rgba(220,158,35,0.35);
    }
    .btn-secondary {
      background: #fff9ec;
      border: 1px solid #e0c080;
      color: #6b502c;
    }
    .btn-primary:active, .btn-secondary:active {
      transform: translateY(1px);
    }
    input, select, textarea {
      font-family: inherit;
      font-size: 13px;
      padding: 5px 8px;
      border-radius: 8px;
      border: 1px solid #e0c080;
      background: #fffdf5;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #f0d9a4;
      vertical-align: top;
    }
    th {
      background: #fff7df;
      font-weight: 600;
      color: #7b5b30;
      text-align: left;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }
    .pill-pending {
      background: #fff3cd;
      color: #856404;
    }
    .pill-completed {
      background: #d4edda;
      color: #155724;
    }
    details summary {
      cursor: pointer;
      color: #a36822;
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .mt-8 { margin-top: 8px; }
    .mt-12 { margin-top: 12px; }
    .text-right { text-align: right; }
    .text-center { text-align: center; }
    .muted { color: #9a7641; font-size: 12px; }
.scroll-box {
  max-height: 500px; /* åŠ å¤§é«˜åº¦ */
  overflow-y: scroll;
  background: #fffdf5;
  padding: 8px;
  border-radius: 10px;
  border: 1px dashed #f0d9a4;
}
    @media (max-width: 768px) {
      .header-inner {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="logo">
      <div class="logo-badge">â˜€</div>
      å¾Œå°ç®¡ç†ï½œä¸‰å°éš»æ—¥å¸¸ç™¾è²¨
    </div>
<div class="muted">
  é€£ç·šå¾Œç«¯ server.jsï¼Œè®€å–è¨‚å–® / å•†å“è¨­å®šè³‡æ–™åº«ï¼ˆSQLiteï¼‰
</div>
  </div>
</header>

<main>
  <!-- ç™»å…¥å¡ç‰‡ -->
  <section class="card" id="loginCard">
    <div class="card-title">
      å¾Œå°ç™»å…¥
      <span class="tag">é è¨­å¯†ç¢¼ demo123</span>
    </div>
<p class="card-sub">
  é€™æ˜¯ã€ŒçœŸå¯¦å¾Œå°ã€ï¼Œæ‰€æœ‰è¨‚å–®èˆ‡å•†å“è¨­å®šéƒ½æœƒå¯«å…¥ä¼ºæœå™¨çš„ SQLite è³‡æ–™åº«ã€‚<br>
  å‰å°çµå¸³ç”¢ç”Ÿçš„è¨‚å–®æœƒåŒæ­¥åˆ°é€™è£¡ï¼Œä½ å¯ä»¥ç®¡ç†è¨‚å–®ã€èª¿æ•´åƒ¹æ ¼èˆ‡åº«å­˜ã€‚
</p>
    <div class="flex-row mt-8">
      <input type="password" id="adminPassword" placeholder="è«‹è¼¸å…¥å¾Œå°å¯†ç¢¼ï¼ˆdemo123ï¼‰">
      <button type="button" class="btn-primary" id="adminLoginBtn">ç™»å…¥</button>
      <span id="adminLoginMsg" class="muted" style="color:#b5532e;"></span>
    </div>
  </section>

  <!-- çœŸæ­£çš„å¾Œå°å…§å®¹ -->
  <section id="adminPanel" style="display:none;">
    <!-- ç¸½è¦½ -->
    <section class="card">
      <div class="card-title">
        å¾Œå°ç¸½è¦½
      </div>
      <div class="flex-row">
        <div>
          <div class="muted">ç›®å‰è¨‚å–®ç­†æ•¸</div>
          <div id="summaryOrderCount" style="font-size:20px; font-weight:700; color:#e59b29;">0</div>
        </div>
        <div>
          <div class="muted">å·²å®Œçµè¨‚å–®</div>
          <div id="summaryCompletedCount" style="font-size:20px; font-weight:700; color:#8fbc50;">0</div>
        </div>
        <div>
          <div class="muted">è¨‚å–®ç¸½é‡‘é¡</div>
          <div id="summaryTotalAmount" style="font-size:20px; font-weight:700; color:#e08a1e;">NT$ 0</div>
        </div>
      </div>
    </section>

    <!-- å•†å“ç®¡ç†ï¼šåƒ¹æ ¼ / å„æ¬¾å¼åº«å­˜ -->
    <section class="card">
      <div class="card-title">
        å•†å“ç®¡ç†
        <span class="tag">å¯èª¿åƒ¹æ ¼èˆ‡æ¯å€‹æ¬¾å¼åº«å­˜</span>
      </div>
    <p class="card-sub">
  é€™è£¡æœƒè®€å–å•†å“çš„åŸºæœ¬è³‡æ–™ï¼Œå¯¦éš›åƒ¹æ ¼èˆ‡åº«å­˜ä»¥å¾Œç«¯è³‡æ–™åº«ç‚ºä¸»ã€‚<br>
  ä¿®æ”¹å¾Œè«‹è¨˜å¾—æŒ‰ã€Œå„²å­˜ã€ï¼Œæœƒå³æ™‚å¯«å…¥ä¼ºæœå™¨ä¸Šçš„ SQLiteã€‚
</p>
      <div id="adminProducts" class="scroll-box">
        ï¼ˆè¼‰å…¥ä¸­â€¦ï¼‰
      </div>
    </section>

    <!-- è¨‚å–®ç®¡ç† -->
    <section class="card">
      <div class="card-title">
        è¨‚å–®ç®¡ç†
        <span class="tag">å¯æ”¹è¨‚å–®ç‹€æ…‹ã€æŸ¥çœ‹æ˜ç´°</span>
      </div>
      <div class="flex-row mt-8">
        <button type="button" class="btn-secondary" id="btnRefreshOrders">é‡æ–°è¼‰å…¥è¨‚å–®</button>
        <span class="muted">ç‹€æ…‹æ”¹ç‚ºã€Œå·²å®Œçµã€æ™‚æœƒè‡ªå‹•è¨˜éŒ„å®Œçµæ™‚é–“ã€‚</span>
      </div>
      <div id="adminOrders" class="scroll-box mt-8">
        ï¼ˆç›®å‰æ²’æœ‰è¨‚å–®ï¼‰
      </div>
    </section>

    <!-- æ¯æœˆéŠ·é‡çµ±è¨ˆ -->
    <section class="card">
      <div class="card-title">
        æ¯æœˆéŠ·é‡çµ±è¨ˆ
        <span class="tag">ä¾è¨‚å–®è³‡æ–™è‡ªå‹•çµ±è¨ˆ</span>
      </div>
      <div class="flex-row mt-8">
        <label class="muted">
          çµ±è¨ˆæœˆä»½ï¼š
          <input type="month" id="adminMonth">
        </label>
        <button type="button" class="btn-secondary" id="adminRefreshStats">
          é‡æ–°è¨ˆç®—
        </button>
      </div>
      <div id="adminStats" class="mt-8 muted">
        å°šæœªé¸æ“‡æœˆä»½ã€‚
      </div>
    </section>
  </section>
</main>

<script>
  // ================== å¾Œç«¯ä½å€è¨­å®š ==================
  // æœªä¾†ä¼ºæœå™¨å¦‚æœä¸åœ¨åŒä¸€å°ï¼Œåªè¦æ”¹é€™è£¡çš„ç¶²å€å³å¯
const API_BASE = 'https://sanxiaozi-shop.onrender.com'; // æˆ– const API_BASE = window.location.origin;


  // ============ å•†å“åŸºæœ¬è³‡æ–™ï¼ˆçµ¦å¾Œå°ç”¨ï¼Œèˆ‡å‰å°å°æ‡‰ï¼‰ ============
  // é€™è£¡åªéœ€è¦ id / name / specs(key + label)ï¼Œä¸éœ€è¦åœ–ç‰‡
  const products = [
    {
      id: 'chiikawa',
      name: 'Chiikawa å‰ä¼Šå¡å“‡ A6 æ´»é è¨˜äº‹æœ¬',
      specs: [
        { key: 'usagi', label: 'çƒè–©å¥‡ï¼ˆé»ƒï¼‰' },
        { key: 'kuri',  label: 'å°å…«ï¼ˆè—ï¼‰' },
        { key: 'chii',  label: 'å‰ä¼Šï¼ˆç²‰ï¼‰' }
      ]
    },
    {
      id: 'product-thermo',
      name: '520ml 316ä¸é½é‹¼ä¿æº«æ¯',
      specs: [
        { key: '537-01', label: '537ä¿æº«æ¯-01' },
        { key: '537-02', label: '537ä¿æº«æ¯-02' },
        { key: '537-03', label: '537ä¿æº«æ¯-03' },
        { key: '537-04', label: '537ä¿æº«æ¯-04' },
        { key: '537-05', label: '537ä¿æº«æ¯-05' },
        { key: '537-06', label: '537ä¿æº«æ¯-06' },
        { key: '537-07', label: '537ä¿æº«æ¯-07' },
        { key: '537-08', label: '537ä¿æº«æ¯-08' },
        { key: 'chi-01', label: 'chiikawaä¿æº«æ¯-01' },
        { key: 'chi-02', label: 'chiikawaä¿æº«æ¯-02' },
        { key: 'chi-03', label: 'chiikawaä¿æº«æ¯-03' },
        { key: 'chi-04', label: 'chiikawaä¿æº«æ¯-04' },
        { key: 'ge-01',  label: 'geä¿æº«æ¯-01' },
        { key: 'ko-08-01', label: 'å°å…«ä¿æº«æ¯-01' },
        { key: 'ko-08-02', label: 'å°å…«ä¿æº«æ¯-02' }
      ]
    },
    {
      id: 'cup-new-chiikawa',
      name: '500ml æ–°æ¬¾ Chiikawa 316ä¸é½é‹¼ä¿æº«æ¯',
      specs: [
        { key: 'n-01', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-01' },
        { key: 'n-02', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-02' },
        { key: 'n-03', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-03' },
        { key: 'n-04', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-04' },
        { key: 'n-05', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-05' },
        { key: 'n-06', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-06' },
        { key: 'n-07', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-07' },
        { key: 'n-08', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-08' },
        { key: 'n-09', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-09' },
        { key: 'n-10', label: 'æ–°æ¬¾chiikawaä¿æº«æ¯-10' }
      ]
    },
    {
      id: 'chiikawa-bag',
      name: 'Chiikawa å‰ä¼Šå¡å“‡å¸†å¸ƒè¢‹',
      specs: [
        { key: 'b1',  label: 'æ¬¾å¼ 1' },
        { key: 'b2',  label: 'æ¬¾å¼ 2' },
        { key: 'b3',  label: 'æ¬¾å¼ 3' },
        { key: 'b4',  label: 'æ¬¾å¼ 4' },
        { key: 'b5',  label: 'æ¬¾å¼ 5' },
        { key: 'b6',  label: 'æ¬¾å¼ 6' },
        { key: 'b7',  label: 'æ¬¾å¼ 7' },
        { key: 'b8',  label: 'æ¬¾å¼ 8' },
        { key: 'b9',  label: 'æ¬¾å¼ 9' },
        { key: 'b10', label: 'æ¬¾å¼ 10' },
        { key: 'b11', label: 'æ¬¾å¼ 11' },
        { key: 'b12', label: 'æ¬¾å¼ 12' },
        { key: 'b13', label: 'æ¬¾å¼ 13' },
        { key: 'b14', label: 'æ¬¾å¼ 14' },
        { key: 'b15', label: 'æ¬¾å¼ 15' },
        { key: 'b16', label: 'æ¬¾å¼ 16' },
        { key: 'b17', label: 'æ¬¾å¼ 17' },
        { key: 'b18', label: 'æ¬¾å¼ 18' },
        { key: 'b19', label: 'æ¬¾å¼ 19' },
        { key: 'b20', label: 'æ¬¾å¼ 20' }
      ]
    }
  ];

  // ============ èˆ‡å¾Œç«¯æºé€šç”¨ ============

  // å…¨åŸŸè¨‚å–®å¿«å–ï¼ˆé¿å…æ¯å€‹åŠŸèƒ½éƒ½é‡æŠ“ï¼‰
  let cachedOrders = [];

  // å¾å¾Œç«¯è¼‰å…¥å•†å“ç‹€æ…‹ï¼ˆåƒ¹æ ¼ / å„æ¬¾å¼åº«å­˜ï¼‰
  async function loadProductsStateFromServer() {
    try {
      const res = await fetch(`${API_BASE}/api/product-state`);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const saved = await res.json(); // { [productId]: { price, priceNote, stocks } }

      products.forEach(p => {
        const m = saved[p.id];
        if (!m) return;

        if (typeof m.price === 'number') p.price = m.price;
        if (typeof m.priceNote === 'string') p.priceNote = m.priceNote;

        if (m.stocks && Array.isArray(p.specs)) {
          p.specs.forEach(spec => {
            const sVal = m.stocks[spec.key];
            if (typeof sVal === 'number') {
              spec.stock = sVal;
            }
          });
        }
      });
    } catch (e) {
      console.warn('loadProductsStateFromServer error', e);
      alert('ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥å•†å“è¨­å®šï¼ˆåƒ¹æ ¼ / åº«å­˜ï¼‰ï¼Œè«‹ç¢ºèªä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œã€‚');
    }
  }

  // æŠŠæŸä¸€å€‹å•†å“çš„åƒ¹æ ¼ + åº«å­˜å­˜å›å¾Œç«¯
  async function saveProductStateToServer(product) {
    const stocks = {};
    if (Array.isArray(product.specs)) {
      product.specs.forEach(spec => {
        if (typeof spec.stock === 'number') {
          stocks[spec.key] = spec.stock;
        }
      });
    }

    const payload = {
      price: product.price,
      priceNote: product.priceNote || '',
      stocks
    };

    const res = await fetch(`${API_BASE}/api/product-state/${encodeURIComponent(product.id)}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const text = await res.text().catch(() => '');
      throw new Error('saveProductStateToServer error: ' + res.status + ' ' + text);
    }
  }

  // å¾å¾Œç«¯æŠ“å…¨éƒ¨è¨‚å–®ï¼ˆæœƒæ›´æ–° cachedOrdersï¼‰
  async function reloadOrdersFromServer() {
    const res = await fetch(`${API_BASE}/api/orders`);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    cachedOrders = await res.json();
  }

  // å¾Œç«¯ä¿®æ”¹è¨‚å–®ç‹€æ…‹
  async function updateOrderStatusOnServer(orderId, newStatus) {
    const res = await fetch(`${API_BASE}/api/orders/${encodeURIComponent(orderId)}/status`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ status: newStatus })
    });
    if (!res.ok) {
      const text = await res.text().catch(() => '');
      throw new Error('updateOrderStatusOnServer error: ' + res.status + ' ' + text);
    }
  }

  // æŒ‰æœˆä»½çµ±è¨ˆï¼ˆç”¨ cachedOrders ä¾†ç®—ï¼‰
  function calcMonthlyStats(orders, year, month) {
    const result = {
      year,
      month,
      orderCount: 0,
      completedCount: 0,
      totalAmount: 0,
      products: {} // { productId: { name, qty, amount } }
    };

    orders.forEach(o => {
      if (!o.createdAt) return;
      const t = new Date(o.createdAt);
      const oy = t.getFullYear();
      const om = t.getMonth() + 1;
      if (oy !== year || om !== month) return;

      result.orderCount += 1;
      if (o.status === 'completed') result.completedCount += 1;
      result.totalAmount += o.totalAmount || 0;

      (o.items || []).forEach(item => {
        const pid = item.productId;
        if (!result.products[pid]) {
          result.products[pid] = {
            name: item.name,
            qty: 0,
            amount: 0
          };
        }
        result.products[pid].qty += item.qty;
        result.products[pid].amount += (item.price || 0) * item.qty;
      });
    });

    return result;
  }

  // ============ å¾Œå°ç™»å…¥ ============

  const ADMIN_PASSWORD = 'demo123';

  const loginCard = document.getElementById('loginCard');
  const adminPanel = document.getElementById('adminPanel');
  const adminPasswordInput = document.getElementById('adminPassword');
  const adminLoginBtn = document.getElementById('adminLoginBtn');
  const adminLoginMsg = document.getElementById('adminLoginMsg');

  if (adminLoginBtn) {
    adminLoginBtn.addEventListener('click', () => {
      const pwd = (adminPasswordInput.value || '').trim();
      if (pwd === ADMIN_PASSWORD) {
        loginCard.style.display = 'none';
        adminPanel.style.display = 'block';
        adminLoginMsg.textContent = '';
        initAdmin(); // ç™»å…¥å¾Œå•Ÿå‹•å¾Œå°
      } else {
        adminLoginMsg.textContent = 'å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚';
      }
    });
  }

  // ä¹Ÿå¯ä»¥æŒ‰ Enter ç™»å…¥
  if (adminPasswordInput) {
    adminPasswordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') adminLoginBtn.click();
    });
  }

  // ============ å¾Œå°åˆå§‹åŒ–ï¼šè¼‰å…¥è³‡æ–™ã€æ¸²æŸ“ç•«é¢ ============

  const adminProductsDiv = document.getElementById('adminProducts');
  const adminOrdersDiv = document.getElementById('adminOrders');
  const adminMonthInput = document.getElementById('adminMonth');
  const adminStatsDiv = document.getElementById('adminStats');
  const btnRefreshOrders = document.getElementById('btnRefreshOrders');
  const btnRefreshStats = document.getElementById('adminRefreshStats');

  const summaryOrderCount = document.getElementById('summaryOrderCount');
  const summaryCompletedCount = document.getElementById('summaryCompletedCount');
  const summaryTotalAmount = document.getElementById('summaryTotalAmount');

  async function initAdmin() {
    // 1. å¾å¾Œç«¯è¼‰å…¥å•†å“ç‹€æ…‹ï¼ˆåƒ¹æ ¼ / åº«å­˜ï¼‰
    await loadProductsStateFromServer();
    // 2. æ¸²æŸ“å•†å“ç®¡ç†ç•«é¢
    renderAdminProducts();
    // 3. å…ˆæŠ“ä¸€æ¬¡è¨‚å–® + æ¸²æŸ“è¨‚å–®åˆ—è¡¨
    await reloadOrdersFromServer();
    renderAdminOrders();
    // 4. è¨­å®šæœˆä»½ + æ¸²æŸ“çµ±è¨ˆ & ç¸½è¦½
    initAdminMonth();
    renderAdminSummary();
  }

  // ============ å•†å“ç®¡ç†ï¼šæ¸²æŸ“åˆ—è¡¨ ============

  function renderAdminProducts() {
    if (!adminProductsDiv) return;

    let html = '<table><thead><tr>' +
      '<th>å•†å“</th>' +
      '<th style="width:120px;">åƒ¹æ ¼ï¼ˆNT$ï¼‰</th>' +
      '<th>æ¬¾å¼åº«å­˜ï¼ˆæ¯å€‹æ¬¾å¼ï¼‰</th>' +
      '<th style="width:80px;">æ“ä½œ</th>' +
      '</tr></thead><tbody>';

    products.forEach(p => {
      const priceVal = (typeof p.price === 'number' && p.price > 0) ? p.price : '';

      let specsHtml = '';
      if (Array.isArray(p.specs)) {
        specsHtml = p.specs.map(spec => {
          const stockVal = (typeof spec.stock === 'number') ? spec.stock : '';
          const dataKey = `${p.id}|${spec.key}`;
          return `
            <div style="margin-bottom:3px;">
              <span>${spec.label}</span>
              <input type="number"
                     data-spec-stock="${dataKey}"
                     value="${stockVal}"
                     placeholder="ä¸é™"
                     style="width:80px; margin-left:6px;">
            </div>
          `;
        }).join('');
      }

      html += `
        <tr>
          <td>${p.name}</td>
          <td class="text-center">
            <input type="number"
                   data-admin-price="${p.id}"
                   value="${priceVal}"
                   placeholder="æœªè¨­å®š"
                   style="width:100px;">
          </td>
          <td>${specsHtml || '<span class="muted">æ­¤å•†å“å°šæœªè¨­å®šæ¬¾å¼</span>'}</td>
          <td class="text-center">
            <button type="button"
                    class="btn-secondary"
                    style="padding:3px 10px; font-size:11px;"
                    onclick="window.adminSaveProduct('${p.id}')">
              å„²å­˜
            </button>
          </td>
        </tr>
      `;
    });

    html += '</tbody></table>';
    adminProductsDiv.innerHTML = html;
  }

  window.adminSaveProduct = async function(productId) {
    const product = products.find(p => p.id === productId);
    if (!product) return;

    const priceInput = document.querySelector(`input[data-admin-price="${productId}"]`);
    if (!priceInput) return;

    const newPrice = Number(priceInput.value);
    if (Number.isNaN(newPrice) || newPrice <= 0) {
      alert('åƒ¹æ ¼å¿…é ˆæ˜¯å¤§æ–¼ 0 çš„æ•¸å­—');
      return;
    }
    product.price = newPrice;

    if (Array.isArray(product.specs)) {
      product.specs.forEach(spec => {
        const key = `${productId}|${spec.key}`;
        const stockInput = document.querySelector(`input[data-spec-stock="${key}"]`);
        if (!stockInput) return;
        const v = stockInput.value;
        if (v === '') {
          spec.stock = undefined; // ä¸é™é‡
        } else {
          const num = Number(v);
          if (Number.isNaN(num) || num < 0) {
            spec.stock = 0;
            stockInput.value = 0;
          } else {
            spec.stock = num;
          }
        }
      });
    }

    try {
      await saveProductStateToServer(product);
      alert(`ã€Œ${product.name}ã€å·²æ›´æ–°åƒ¹æ ¼èˆ‡åº«å­˜ï¼ˆå·²å¯«å…¥å¾Œç«¯è³‡æ–™åº«ï¼‰ã€‚`);
    } catch (e) {
      console.error(e);
      alert('å„²å­˜åˆ°å¾Œç«¯å¤±æ•—ï¼Œè«‹ç¢ºèªä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œã€‚');
    }
  };

  // ============ è¨‚å–®ç®¡ç†ï¼šæ¸²æŸ“åˆ—è¡¨ ============

  async function renderAdminOrders() {
    if (!adminOrdersDiv) return;

    try {
      await reloadOrdersFromServer();
    } catch (e) {
      console.error('renderAdminOrders reload error', e);
      adminOrdersDiv.innerHTML = 'ç„¡æ³•å¾å¾Œç«¯è¼‰å…¥è¨‚å–®ï¼Œè«‹ç¢ºèªä¼ºæœå™¨æ˜¯å¦æ­£å¸¸é‹ä½œã€‚';
      renderAdminSummary();
      return;
    }

    const orders = cachedOrders;

    if (!orders.length) {
      adminOrdersDiv.innerHTML = 'ç›®å‰æ²’æœ‰è¨‚å–®ã€‚';
      renderAdminSummary();
      return;
    }

    let html = '<table><thead><tr>' +
      '<th>è¨‚å–®ç·¨è™Ÿ</th>' +
      '<th>æ™‚é–“</th>' +
      '<th>ç‹€æ…‹</th>' +
      '<th class="text-right">é‡‘é¡</th>' +
      '<th>å®¢æˆ¶</th>' +
      '<th>æ˜ç´°</th>' +
      '</tr></thead><tbody>';

    orders
      .slice()
      .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
      .forEach(o => {
        const created = o.createdAt ? new Date(o.createdAt) : null;
        const statusPill = o.status === 'completed'
          ? '<span class="pill pill-completed">å·²å®Œçµ</span>'
          : '<span class="pill pill-pending">è™•ç†ä¸­</span>';

        const itemsHtml = (o.items || []).map(it =>
          `${it.name}ï¼ˆ${it.specLabel}ï¼‰Ã—${it.qty} ï¼ NT$${(it.price || 0) * it.qty}`
        ).join('<br>');

        const completedText = o.completedAt
          ? 'å®Œçµæ™‚é–“ï¼š' + new Date(o.completedAt).toLocaleString() + '<br>'
          : '';

        html += `
          <tr>
            <td>${o.id || ''}</td>
            <td>${created ? created.toLocaleString() : ''}</td>
            <td>
              ${statusPill}<br>
              <select style="margin-top:4px; font-size:11px;"
                      onchange="window.adminChangeOrderStatus('${o.id}', this.value)">
                <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>è™•ç†ä¸­</option>
                <option value="completed" ${o.status === 'completed' ? 'selected' : ''}>å·²å®Œçµ</option>
              </select>
            </td>
            <td class="text-right">NT$ ${o.totalAmount || 0}</td>
            <td>
              ${o.customer?.name || ''}<br>
              <span class="muted">${o.customer?.phone || ''}</span>
            </td>
            <td>
              <details>
                <summary>æŸ¥çœ‹</summary>
                <div class="mt-8">
                  ${completedText}
                  é…é€ï¼š${o.customer?.ship || ''}<br>
                  ä»˜æ¬¾ï¼š${o.customer?.pay || ''}<br>
                  ${o.customer?.address ? ('åœ°å€ï¼š' + o.customer.address + '<br>') : ''}
                  ${o.customer?.note ? ('å‚™è¨»ï¼š' + o.customer.note + '<br>') : ''}
                  <br><strong>å“é …ï¼š</strong><br>
                  ${itemsHtml}
                </div>
              </details>
            </td>
          </tr>
        `;
      });

    html += '</tbody></table>';
    adminOrdersDiv.innerHTML = html;
    renderAdminSummary();
  }

  window.adminChangeOrderStatus = async function(orderId, newStatus) {
    try {
      await updateOrderStatusOnServer(orderId, newStatus);
      await reloadOrdersFromServer();
      renderAdminOrders();
    } catch (e) {
      console.error(e);
      alert('æ›´æ–°è¨‚å–®ç‹€æ…‹å¤±æ•—ï¼Œè«‹ç¢ºèª server.js æ˜¯å¦æœ‰åœ¨åŸ·è¡Œã€‚');
    }
  };

  if (btnRefreshOrders) {
    btnRefreshOrders.addEventListener('click', () => {
      renderAdminOrders();
    });
  }

  // ============ æ¯æœˆéŠ·é‡çµ±è¨ˆ ============

  function initAdminMonth() {
    if (!adminMonthInput) return;
    const now = new Date();
    const y = now.getFullYear();
    const m = (now.getMonth() + 1).toString().padStart(2, '0');
    adminMonthInput.value = `${y}-${m}`;
    renderAdminStats();
  }

  function renderAdminStats() {
    if (!adminStatsDiv || !adminMonthInput) return;
    const val = adminMonthInput.value;
    if (!val) {
      adminStatsDiv.textContent = 'è«‹å…ˆé¸æ“‡æœˆä»½ã€‚';
      return;
    }
    const [y, m] = val.split('-');
    const year = Number(y);
    const month = Number(m);
    if (!year || !month) {
      adminStatsDiv.textContent = 'æœˆä»½æ ¼å¼éŒ¯èª¤ã€‚';
      return;
    }

    const orders = cachedOrders || [];
    const stats = calcMonthlyStats(orders, year, month);

    let html = '';
    html += `ğŸ“† çµ±è¨ˆæœˆä»½ï¼š${year} å¹´ ${month} æœˆ<br>`;
    html += `ğŸ“¦ è¨‚å–®æ•¸ï¼š${stats.orderCount} ç­†ï¼ˆå·²å®Œçµ ${stats.completedCount} ç­†ï¼‰<br>`;
    html += `ğŸ’° ç¸½é‡‘é¡ï¼šNT$ ${stats.totalAmount}<br>`;

    const keys = Object.keys(stats.products);
    if (!keys.length) {
      html += '<br>æœ¬æœˆå°šç„¡å•†å“éŠ·å”®ç´€éŒ„ã€‚';
    } else {
      html += '<br><strong>å•†å“éŠ·é‡ï¼š</strong><br>';
      html += '<ul style="padding-left:20px; margin-top:4px;">';
      keys.forEach(pid => {
        const p = stats.products[pid];
        html += `<li>${p.name}ï¼š${p.qty} ä»¶ï¼ŒNT$ ${p.amount}</li>`;
      });
      html += '</ul>';
    }

    adminStatsDiv.innerHTML = html;
  }

  if (btnRefreshStats) {
    btnRefreshStats.addEventListener('click', renderAdminStats);
  }

  // ============ ç¸½è¦½æ•¸å­—ï¼ˆä¸Šæ–¹ä¸‰å€‹å°å¡ï¼‰ ============

  function renderAdminSummary() {
    const orders = cachedOrders || [];
    const count = orders.length;
    const completed = orders.filter(o => o.status === 'completed').length;
    const totalAmount = orders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);

    if (summaryOrderCount) summaryOrderCount.textContent = count;
    if (summaryCompletedCount) summaryCompletedCount.textContent = completed;
    if (summaryTotalAmount) summaryTotalAmount.textContent = 'NT$ ' + totalAmount;
  }
</script>
</body>
</html>
